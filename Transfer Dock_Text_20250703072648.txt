-- RSPY ULTIMATE PREMIUM v4.0
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

--= Premium Loading Screen =--
local loadingScreen = Instance.new("ScreenGui", CoreGui)
loadingScreen.Name = "RSPY_Loading"
loadingScreen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local loadFrame = Instance.new("Frame")
loadFrame.Size = UDim2.new(1, 0, 1, 0)
loadFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
loadFrame.Parent = loadingScreen

local loadLogo = Instance.new("ImageLabel")
loadLogo.Image = "rbxassetid://7072717162"  -- Replace with your logo ID
loadLogo.Size = UDim2.new(0, 150, 0, 150)
loadLogo.Position = UDim2.new(0.5, -75, 0.4, -75)
loadLogo.BackgroundTransparency = 1
loadLogo.Parent = loadFrame

local loadText = Instance.new("TextLabel")
loadText.Text = "RSPY ULTIMATE PREMIUM"
loadText.Font = Enum.Font.GothamBold
loadText.TextSize = 24
loadText.TextColor3 = Color3.new(1, 1, 1)
loadText.BackgroundTransparency = 1
loadText.Position = UDim2.new(0.5, 0, 0.6, 0)
loadText.AnchorPoint = Vector2.new(0.5, 0)
loadText.Parent = loadFrame

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0.4, 0, 0, 8)
progressBar.Position = UDim2.new(0.3, 0, 0.7, 0)
progressBar.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
progressBar.Parent = loadFrame
Instance.new("UICorner", progressBar).CornerRadius = UDim.new(1, 0)

local progressFill = Instance.new("Frame")
progressFill.Size = UDim2.new(0, 0, 1, 0)
progressFill.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
progressFill.Parent = progressBar
Instance.new("UICorner", progressFill).CornerRadius = UDim.new(1, 0)

-- Simulate loading
for i = 1, 10 do
    progressFill.Size = UDim2.new(i/10, 0, 1, 0)
    loadText.Text = "Initializing... "..i*10.."%"
    wait(0.1)
end

--= Premium UI Library =--
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/shlexware/Rayfield/main/source'))()
local Window = Rayfield:CreateWindow({
    Name = "RSPY ULTIMATE PREMIUM",
    LoadingTitle = "Premium Features Loading",
    LoadingSubtitle = "by elite developers",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "RSPY_Config",
        FileName = "PremiumConfig"
    },
    KeySystem = false,
})

--= Feature Toggles =--
local Tabs = {
    Player = Window:CreateTab("Player", 4483362458),
    Visuals = Window:CreateTab("Visuals", 4483362458),
    Combat = Window:CreateTab("Combat", 4483362458),
    World = Window:CreateTab("World", 4483362458),
    Settings = Window:CreateTab("Settings", 4483362458)
}

-- Player Tab
local MovementSection = Tabs.Player:CreateSection("Movement")
local SpeedToggle = Tabs.Player:CreateToggle({
    Name = "Speed Hack",
    CurrentValue = false,
    Flag = "SpeedToggle",
    Callback = function(Value)
        _G.SpeedEnabled = Value
    end
})

local SpeedSlider = Tabs.Player:CreateSlider({
    Name = "Walk Speed",
    Range = {16, 200},
    Increment = 1,
    Suffix = "studs/s",
    CurrentValue = 50,
    Flag = "SpeedSlider",
    Callback = function(Value)
        _G.SpeedValue = Value
    end
})

local FlyToggle = Tabs.Player:CreateToggle({
    Name = "Flight Mode",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(Value)
        _G.FlyEnabled = Value
    end
})

local InfiniteJumpToggle = Tabs.Player:CreateToggle({
    Name = "Infinite Jump",
    CurrentValue = false,
    Flag = "InfiniteJump",
    Callback = function(Value)
        _G.InfiniteJump = Value
    end
})

-- Visuals Tab
local ESPSection = Tabs.Visuals:CreateSection("ESP Configuration")
local ESPMasterToggle = Tabs.Visuals:CreateToggle({
    Name = "ESP Master Switch",
    CurrentValue = false,
    Flag = "ESPMaster",
    Callback = function(Value)
        _G.ESPMaster = Value
        if not Value then
            -- Clear all ESP when master is off
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= localPlayer and player.Character then
                    local esp = player.Character:FindFirstChild("RSPY_ESP")
                    if esp then esp:Destroy() end
                end
            end
        end
    end
})

local BoxesToggle = Tabs.Visuals:CreateToggle({
    Name = "Box ESP",
    CurrentValue = true,
    Flag = "BoxESP",
    Callback = function(Value)
        _G.BoxESP = Value
        updateESP()
    end
})

local NamesToggle = Tabs.Visuals:CreateToggle({
    Name = "Show Names",
    CurrentValue = true,
    Flag = "NameESP",
    Callback = function(Value)
        _G.NameESP = Value
        updateESP()
    end
})

local HealthToggle = Tabs.Visuals:CreateToggle({
    Name = "Health Bars",
    CurrentValue = true,
    Flag = "HealthESP",
    Callback = function(Value)
        _G.HealthESP = Value
        updateESP()
    end
})

-- Combat Tab
local AimbotSection = Tabs.Combat:CreateSection("Aimbot")
local AimbotToggle = Tabs.Combat:CreateToggle({
    Name = "Aimbot",
    CurrentValue = false,
    Flag = "AimbotToggle",
    Callback = function(Value)
        _G.AimbotEnabled = Value
    end
})

local FlingSection = Tabs.Combat:CreateSection("Fling System")
local AntiFlingToggle = Tabs.Combat:CreateToggle({
    Name = "Anti-Fling Protection",
    CurrentValue = false,
    Flag = "AntiFling",
    Callback = function(Value)
        _G.AntiFling = Value
    end
})

local FlingToggle = Tabs.Combat:CreateToggle({
    Name = "Fling Players",
    CurrentValue = false,
    Flag = "FlingPlayers",
    Callback = function(Value)
        _G.FlingPlayers = Value
    end
})

--= Premium Feature Implementations =--
local espCache = {}
local flyConnection

-- Enhanced Flight System
local function fly()
    if not _G.FlyEnabled then 
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        return 
    end

    flyConnection = RunService.Heartbeat:Connect(function()
        local root = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not root then return end
        
        local velocity = Vector3.new(0, 0, 0)
        local camera = workspace.CurrentCamera
        local cf = camera.CFrame
        
        if UIS:IsKeyDown(Enum.KeyCode.W) then velocity = velocity + cf.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then velocity = velocity - cf.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then velocity = velocity + cf.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then velocity = velocity - cf.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then velocity = velocity + Vector3.new(0, 1, 0) end
        if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then velocity = velocity - Vector3.new(0, 1, 0) end
        
        root.Velocity = velocity * 100
        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    end)
end

-- Fixed ESP System
function updateESP()
    if not _G.ESPMaster then return end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            if espCache[player] then
                espCache[player]:Destroy()
                espCache[player] = nil
            end

            local espFrame = Instance.new("Folder")
            espFrame.Name = "RSPY_ESP"
            espFrame.Parent = player.Character
            
            -- Box Highlight
            if _G.BoxESP then
                local highlight = Instance.new("Highlight")
                highlight.OutlineTransparency = 0
                highlight.FillTransparency = 0.8
                highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                highlight.Adornee = player.Character
                highlight.Parent = espFrame
                
                -- Team Colors
                if player.Team ~= localPlayer.Team then
                    highlight.FillColor = Color3.new(1, 0, 0) -- Red for enemies
                else
                    highlight.FillColor = Color3.new(0, 1, 0) -- Green for teammates
                end
            end
            
            -- Name Label
            if _G.NameESP then
                local billboard = Instance.new("BillboardGui")
                billboard.Size = UDim2.new(0, 100, 0, 30)
                billboard.StudsOffset = Vector3.new(0, 3, 0)
                billboard.AlwaysOnTop = true
                billboard.Adornee = player.Character:WaitForChild("Head")
                billboard.Parent = espFrame
                
                local nameLabel = Instance.new("TextLabel")
                nameLabel.Text = player.DisplayName or player.Name
                nameLabel.Size = UDim2.new(1, 0, 1, 0)
                nameLabel.BackgroundTransparency = 1
                nameLabel.TextColor3 = Color3.new(1, 1, 1)
                nameLabel.TextStrokeTransparency = 0
                nameLabel.TextSize = 14
                nameLabel.Font = Enum.Font.GothamBold
                nameLabel.Parent = billboard
            end
            
            espCache[player] = espFrame
        end
    end
end

-- Advanced Fling System
local function flingPlayer()
    if not _G.FlingPlayers then return end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local root = player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                root.Velocity = Vector3.new(
                    math.random(-50000, 50000),
                    math.random(50000, 100000),
                    math.random(-50000, 50000)
                )
                root.RotVelocity = Vector3.new(
                    math.random(-100, 100),
                    math.random(-100, 100),
                    math.random(-100, 100)
                )
            end
        end
    end
end

--= Core Systems =--
RunService.Heartbeat:Connect(function()
    -- Movement systems
    if localPlayer.Character then
        local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            -- Walk Speed
            if _G.SpeedEnabled then
                humanoid.WalkSpeed = _G.SpeedValue
            else
                humanoid.WalkSpeed = 16
            end
            
            -- Flight
            if _G.FlyEnabled then fly() end
            
            -- Infinite Jump
            if _G.InfiniteJump and UIS:IsKeyDown(Enum.KeyCode.Space) then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
            
            -- Anti-Fling
            if _G.AntiFling then
                local root = localPlayer.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    root.Velocity = Vector3.new(0, 0, 0)
                    root.RotVelocity = Vector3.new(0, 0, 0)
                    root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    root.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                end
            end
        end
    end
    
    -- Fling players
    flingPlayer()
end)

--= Initialization =--
-- Remove loading screen
wait(1)
loadingScreen:Destroy()

-- Auto-update ESP
Players.PlayerAdded:Connect(updateESP)
Players.PlayerRemoving:Connect(function(player)
    if espCache[player] then
        espCache[player]:Destroy()
        espCache[player] = nil
    end
end)

-- First ESP update
updateESP()

Rayfield:Notify({
    Title = "RSPY ULTIMATE LOADED",
    Content = "Premium features activated!",
    Duration = 5,
    Image = 4483362458
})